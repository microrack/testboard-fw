<!DOCTYPE html>
<html>
<head>
    <title>Testboard Configuration Editor</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 5px auto;
            padding: 5px;
            background-color: #f5f5f5;
        }
        .action-buttons {
            display: flex;
            gap: 3px;
            margin-left: auto;
        }
        .action-buttons {
            display: flex;
            gap: 3px;
            margin-left: auto;
        }
        .btn {
            padding: 6px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.3s;
            min-width: 80px;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #545b62; }
        
        .file-input {
            display: none;
        }
        
        .module-section {
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }
        
        .module-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .module-header h3 {
            margin: 0;
            color: #495057;
        }
        
        .module-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .module-selector input, .module-selector select {
            padding: 4px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .edit-mode-tabs {
            display: flex;
            gap: 2px;
        }
        
        .edit-mode-tabs .btn {
            padding: 4px 8px;
            font-size: 11px;
            min-width: auto;
        }
        
        .edit-mode-tabs .btn.active {
            background-color: #007bff;
            color: white;
        }
        
        .edit-mode-tabs .btn:not(.active) {
            background-color: #6c757d;
            color: white;
        }
        
        .aliases-section {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }
        
        .aliases-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }
        
        .aliases-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .alias-line {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 2px;
        }
        
        .alias-line-number {
            min-width: 25px;
            font-size: 11px;
            color: #6c757d;
            text-align: center;
        }
        
        .alias-name-input {
            width: 120px;
            padding: 2px 4px;
            border: 1px solid #ced4da;
            border-radius: 2px;
            font-size: 11px;
        }
        
        .alias-pin-selector {
            width: 100px;
            padding: 2px 4px;
            border: 1px solid #ced4da;
            border-radius: 2px;
            font-size: 11px;
        }
        
        .raw-container {
            display: flex;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .raw-line-numbers {
            width: 125px;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }
        
        .raw-line-number {
            min-width: 50px;
            font-weight: bold;
            color: #6c757d;
            text-align: right;
            font-size: 11px;
            padding: 2px;
            padding-right: 10px;
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
            min-height: 22px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        
        .raw-line-number:nth-child(even) {
            background-color: #ffffff;
        }
        
        .raw-textarea {
            flex: 1;
            min-height: 80px;
            padding: 2px;
            border: none;
            border-radius: 0;
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 27px;
            resize: none;
            overflow: hidden;
            background-color: #f8f9fa;
        }
        
        .operations-list {
            border: 1px solid #dee2e6;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .operation-line {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 2px;
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
            min-height: 22px;
        }
        
        .operation-line:nth-child(even) {
            background-color: #ffffff;
        }
        
        .operation-line.comment-section {
            background-color: #616c77 !important;
            color: #ffffff;
        }
        
        .operation-line.comment-section .line-number {
            color: #ffffff;
        }
        
        .operation-line.comment-section .param-input {
            background-color: #495057;
            border-color: #6c757d;
            color: #ffffff;
        }
        
        /* State colors */
        .state-h {
            background-color: #dc3545 !important;
            color: #ffffff !important;
            border-color: #c82333 !important;
        }
        
        .state-l {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #1e7e34 !important;
        }
        
        .state-z {
            background-color: #17a2b8 !important;
            color: #ffffff !important;
            border-color: #117a8b !important;
        }
        
        .state-p {
            background-color: #ffc107 !important;
            color: #212529 !important;
            border-color: #e0a800 !important;
        }
        
        .operation-line:last-child {
            border-bottom: none;
        }
        
        .line-number {
            min-width: 25px;
            font-weight: bold;
            color: #6c757d;
            text-align: center;
            font-size: 11px;
        }
        
        .operation-type {
            min-width: 100px;
        }
        
        .operation-type select {
            width: 100%;
            padding: 3px 5px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
        }
        
        /* Operation type colors */
        .operation-type select[data-operation="comment"] {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        
        .operation-type select[data-operation="src"] {
            background-color: #d1ecf1;
            border-color: #17a2b8;
        }
        
        .operation-type select[data-operation="io"] {
            background-color: #d4edda;
            border-color: #28a745;
        }
        
        .operation-type select[data-operation="pd"] {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        
        .operation-type select[data-operation="i"] {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        
        .operation-type select[data-operation="v"] {
            background-color: #e2e3e5;
            border-color: #6c757d;
        }
        
        .operation-type select[data-operation="reset"] {
            background-color: #e2d9f3;
            border-color: #6f42c1;
        }
        
        .operation-params {
            display: flex;
            gap: 3px;
            flex: 1;
            align-items: center;
        }
        
        .param-input {
            padding: 3px 5px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
            min-width: 60px;
        }
        
        .param-select {
            padding: 3px 5px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 11px;
            min-width: 60px;
        }
        
        .repeat-checkbox {
            margin: 0;
            transform: scale(1.2);
        }
        
        .line-actions {
            display: flex;
            gap: 2px;
        }
        
        .btn-small {
            padding: 2px 6px;
            font-size: 10px;
            min-width: auto;
        }
        
        .add-operation {
            padding: 4px;
            text-align: center;
            background-color: #e9ecef;
            border-top: 1px solid #dee2e6;
        }
        
        .status {
            padding: 4px;
            border-radius: 3px;
            margin-top: 5px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
        <input type="file" id="fileInput" class="file-input" accept=".txt" onchange="uploadFile(this)">
        
        <div id="status" class="status"></div>
        
        <div class="module-section">
            <div class="module-header">
                <div class="module-selector">
                    <select id="moduleSelector" onchange="selectModule(this.value)">
                        <option value="">Select module</option>
                    </select>
                    <div class="edit-mode-tabs">
                        <button id="editTab" class="btn btn-primary btn-small active" onclick="switchEditMode('edit')">Edit</button>
                        <button id="rawTab" class="btn btn-secondary btn-small" onclick="switchEditMode('raw')">Raw</button>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary btn-small" onclick="downloadFile()">Download</button>
                    <button class="btn btn-warning btn-small" onclick="reloadFromDevice()">Reload</button>
                    <button class="btn btn-success btn-small" onclick="saveToDevice()">Save</button>
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('fileInput').click()">Upload</button>
                </div>
            </div>
        </div>
        
        <div id="aliasesContainer" class="module-section" style="display: none;">
            <div class="aliases-header">
                <span>Pin Aliases</span>
                <button class="btn btn-success btn-small" onclick="addAlias()">Add Alias</button>
            </div>
            <div id="aliasesList" class="aliases-list">
                <!-- Aliases for selected module will be shown here -->
            </div>
        </div>
        
        <div id="operationsContainer" class="module-section" style="display: none;">
            <!-- Operations for selected module will be shown here -->
        </div>

    <script>
        let currentConfig = {
            modules: []
        };
        let selectedModuleIndex = -1;
        let editMode = 'edit'; // 'edit' or 'raw'
        
        // Pin options for aliases
        const pinOptions = [
            'out A', 'out B', 'out C', 'out D',
            'in A', 'in B', 'in C', 'in D', 'in E', 'in F',
            'in pdA', 'in pdB', 'in pdC',
            'in zD', 'in zE', 'in zF',
            '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15'
        ];
        
        // Operation types
        const operationTypes = {
            'src': { name: 'Source', params: ['src_pin', 'voltage'] },
            'io': { name: 'IO', params: ['io_pin', 'state'] },
            'pd': { name: 'Pulldown', params: ['pd_pin', 'pd_state'] },
            'i': { name: 'Check Current', params: ['rail', 'low', 'high'] },
            'v': { name: 'Check Voltage', params: ['pin', 'low', 'high'] },
            'reset': { name: 'Reset', params: [] },
            'comment': { name: 'Comment', params: [] }
        };
        
        // Helper function to replace original pin names with aliases for display
        const replaceWithAlias = (originalName, module) => {
            if (!module || !module.aliases) return originalName;
            
            // First try to find exact match
            let alias = module.aliases.find(a => a.pin === originalName);
            
            return alias ? alias.name : originalName;
        };

        // Helper function to get options with aliases
        const getOptionsWithAliases = (paramType, module) => {
            const baseOptions = paramOptions[paramType] || [];
            const optionsWithAliases = [];
            
            // Process each base option
            baseOptions.forEach(opt => {
                let displayValue = opt;
                if (paramType === 'src_pin') {
                    displayValue = `out ${opt}`;
                } else if (paramType === 'pin') {
                    displayValue = `in ${opt}`;
                }

                // Replace with alias if available
                displayValue = replaceWithAlias(displayValue, module);

                optionsWithAliases.push(displayValue);
            });
            
            return optionsWithAliases;
        };

        // Helper function to get display value
        const getDisplayValue = (value, paramType) => {
            if (paramType === 'src_pin') {
                return `out ${value}`;
            } else if (paramType === 'io_pin') {
                return `out ${value}`;
            } else if (paramType === 'pin') {
                return `in ${value}`;
            }
            return value;
        };

        // Parameter options
        const paramOptions = {
            'pin': ['A', 'B', 'C', 'D', 'E', 'F', 'pdA', 'pdB', 'pdC', 'zD', 'zE', 'zF'],
            'src_pin': ['A', 'B', 'C', 'D'],
            'io_pin': ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15'],
            'pd_pin': ['pdA', 'pdB', 'pdC'],
            'state': ['h', 'l', 'z'],
            'pd_state': ['p', 'z'],
            'rail': ['+12', '+5', '-12']
        };
        
        // Load current configuration on page load
        window.onload = function() {
            loadCurrentConfig();
            
            // Add keyboard shortcut for mode switching
            document.addEventListener('keydown', function(event) {
                if (event.altKey && event.key === 't') {
                    event.preventDefault();
                    const newMode = editMode === 'edit' ? 'raw' : 'edit';
                    switchEditMode(newMode);
                }
            });
        };

        function loadCurrentConfig() {
            fetch('./config')
                .then(response => response.text())
                .then(data => {
                    parseConfig(data);
                    renderConfig();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showStatus('Failed to load configuration', 'error');
                });
        }

        function parseConfig(text) {
            currentConfig.modules = [];
            const lines = text.split('\n');
            let currentModule = null;
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                if (line.startsWith('module ')) {
                    const parts = line.split(' ');
                    if (parts.length >= 3) {
                        currentModule = {
                            name: parts[1],
                            id: parts[2],
                            aliases: [],
                            operations: []
                        };
                        currentConfig.modules.push(currentModule);
                    }
                } else if (line.startsWith('# alias ') && currentModule) {
                    // Parse alias: "# alias <alias_name>=<pin_name>"
                    const aliasMatch = line.match(/^# alias\s+([^=]+)=(.*)$/);
                    if (aliasMatch) {
                        const aliasName = aliasMatch[1].trim();
                        const pinName = aliasMatch[2].trim();
                        currentModule.aliases.push({
                            name: aliasName,
                            pin: pinName
                        });
                    }
                } else if (line.startsWith('#') && currentModule) {
                    currentModule.operations.push({
                        type: 'comment',
                        text: line.substring(1).trim(),
                        repeat: false
                    });
                } else if (currentModule) {
                    const parts = line.split(' ');
                    if (parts.length > 0) {
                        const operation = {
                            type: parts[0],
                            repeat: line.endsWith(' +'),
                            params: parts.slice(1)
                        };
                        if (operation.repeat) {
                            operation.params[operation.params.length - 1] = operation.params[operation.params.length - 1].replace(' +', '');
                        }
                        
                        // Convert original pin names back to display format with aliases
                        if (operation.params && operation.params.length > 0) {
                            operation.params = operation.params.map((param, paramIndex) => {
                                // Store original pin names without prefixes
                                return param;
                            });
                        }
                        
                        currentModule.operations.push(operation);
                    }
                }
            }
            
            if (currentConfig.modules.length === 0) {
                addModule();
            }
        }

        function renderConfig() {
            // Update module selector
            const moduleSelector = document.getElementById('moduleSelector');
            moduleSelector.innerHTML = '<option value="">Select module</option>';
            
            currentConfig.modules.forEach((module, moduleIndex) => {
                const option = document.createElement('option');
                option.value = moduleIndex;
                option.textContent = `${module.name} (ID: ${module.id})`;
                moduleSelector.appendChild(option);
            });
            
            // Show operations for selected module
            if (selectedModuleIndex >= 0 && selectedModuleIndex < currentConfig.modules.length) {
                showModuleOperations(selectedModuleIndex);
            }
        }
        
        function selectModule(moduleIndex) {
            selectedModuleIndex = parseInt(moduleIndex);
            if (selectedModuleIndex >= 0 && selectedModuleIndex < currentConfig.modules.length) {
                showModuleOperations(selectedModuleIndex);
            } else {
                document.getElementById('aliasesContainer').style.display = 'none';
                document.getElementById('operationsContainer').style.display = 'none';
            }
        }
        
        function switchEditMode(mode) {
            editMode = mode;
            
            // Update tab buttons
            document.getElementById('editTab').className = `btn btn-primary btn-small ${mode === 'edit' ? 'active' : ''}`;
            document.getElementById('rawTab').className = `btn btn-secondary btn-small ${mode === 'raw' ? 'active' : ''}`;
            
            // Show appropriate content
            if (selectedModuleIndex >= 0 && selectedModuleIndex < currentConfig.modules.length) {
                showModuleOperations(selectedModuleIndex);
            }
        }
        
        function showModuleOperations(moduleIndex) {
            const aliasesContainer = document.getElementById('aliasesContainer');
            const operationsContainer = document.getElementById('operationsContainer');
            const module = currentConfig.modules[moduleIndex];
            
            // Show aliases
            aliasesContainer.style.display = 'block';
            aliasesContainer.innerHTML = `
                <div class="aliases-header">
                    <span>Pin Aliases</span>
                    <button class="btn btn-success btn-small" onclick="addAlias()">Add Alias</button>
                </div>
                <div id="aliasesList" class="aliases-list">
                    ${module.aliases.map((alias, aliasIndex) => renderAliasLine(moduleIndex, aliasIndex, alias)).join('')}
                </div>
            `;
            
            if (editMode === 'edit') {
                operationsContainer.innerHTML = `
                    <div class="operations-list">
                        ${module.operations.map((op, opIndex) => renderOperationLine(moduleIndex, opIndex, op)).join('')}
                        <div class="add-operation">
                            <button class="btn btn-primary btn-small" onclick="addOperation(${moduleIndex})">Add Operation</button>
                        </div>
                    </div>
                `;
            } else {
                // Raw mode - show textarea with module operations as text
                const moduleText = generateModuleText(module);
                const lines = moduleText.split('\n');
                const lineNumbers = lines.map((_, index) => index + 1).join('</div><div class="raw-line-number">');
                
                operationsContainer.innerHTML = `
                    <div class="raw-container">
                        <div class="raw-line-numbers">
                            <div class="raw-line-number">${lineNumbers}</div>
                        </div>
                        <textarea id="rawModuleText" class="raw-textarea" onchange="updateModuleFromRaw(${moduleIndex}, this.value)" oninput="autoResizeTextarea(this)">${moduleText}</textarea>
                    </div>
                `;
                
                // Auto-resize textarea after it's created
                setTimeout(() => {
                    const textarea = document.getElementById('rawModuleText');
                    if (textarea) {
                        autoResizeTextarea(textarea);
                    }
                }, 10);
            }
            operationsContainer.style.display = 'block';
        }

        function renderAliasLine(moduleIndex, aliasIndex, alias) {
            const lineNumber = aliasIndex + 1;
            return `
                <div class="alias-line">
                    <div class="line-actions">
                        <button class="btn btn-danger btn-small" onclick="removeAlias(${moduleIndex}, ${aliasIndex})">Remove</button>
                        <button class="btn btn-primary btn-small" onclick="editAlias(${moduleIndex}, ${aliasIndex})">Edit</button>
                    </div>
                    <div class="alias-line-number">${lineNumber}</div>
                    <div class="alias-name-input">
                        <input type="text" value="${alias.name}" onchange="updateAliasName(${moduleIndex}, ${aliasIndex}, this.value)" placeholder="Alias name">
                    </div>
                    <div class="alias-pin-selector">
                        <select onchange="updateAliasPin(${moduleIndex}, ${aliasIndex}, this.value)">
                            <option value="">Select pin</option>
                            ${pinOptions.map(pin => {
                                const isSelected = alias.pin === pin;
                                return `<option value="${pin}" ${isSelected ? 'selected' : ''}>${pin}</option>`;
                            }).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        function addAlias() {
            if (selectedModuleIndex >= 0 && selectedModuleIndex < currentConfig.modules.length) {
                currentConfig.modules[selectedModuleIndex].aliases.push({
                    name: '',
                    pin: ''
                });
                showModuleOperations(selectedModuleIndex);
            }
        }

        function removeAlias(moduleIndex, aliasIndex) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                currentConfig.modules[moduleIndex].aliases.splice(aliasIndex, 1);
                showModuleOperations(moduleIndex);
            }
        }

        function editAlias(moduleIndex, aliasIndex) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                const alias = currentConfig.modules[moduleIndex].aliases[aliasIndex];
                const newName = prompt('Enter new alias name:', alias.name);
                if (newName !== null) {
                    alias.name = newName;
                    showModuleOperations(moduleIndex);
                }
            }
        }

        function updateAliasName(moduleIndex, aliasIndex, name) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                currentConfig.modules[moduleIndex].aliases[aliasIndex].name = name;
            }
        }

        function updateAliasPin(moduleIndex, aliasIndex, pin) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                currentConfig.modules[moduleIndex].aliases[aliasIndex].pin = pin;
            }
        }

        function renderOperationLine(moduleIndex, opIndex, operation) {
            const lineNumber = opIndex + 1;
            let paramsHtml = '';
            let isSectionComment = false;
            
            if (operation.type === 'comment') {
                isSectionComment = operation.text && operation.text.startsWith('#');
                paramsHtml = `<input type="text" class="param-input" value="${operation.text || ''}" onchange="updateOperationParam(${moduleIndex}, ${opIndex}, 0, this.value)" placeholder="Comment text">`;
            } else {
                const opType = operationTypes[operation.type];
                if (opType) {
                    paramsHtml = opType.params.map((param, paramIndex) => {
                        let value = operation.params[paramIndex] || '';
                        if (paramOptions[param]) {
                            // Add state color classes for specific operations
                            let stateClass = '';
                            if ((operation.type === 'io' && param === 'state') || 
                                (operation.type === 'pd' && param === 'pd_state')) {
                                if (value && ['h', 'l', 'z', 'p'].includes(value)) {
                                    stateClass = `state-${value}`;
                                }
                            }
                            
                            // Get options with aliases
                            const module = currentConfig.modules[moduleIndex];
                            const optionsWithAliases = getOptionsWithAliases(param, module);

                            // Add prefix for display
                            if (operation.type === 'src') {
                                value = `out ${value}`;
                            } else if (operation.type === 'v') {
                                value = `in ${value}`;
                            }

                            let displayValue = replaceWithAlias(value, module);
                            
                            return `<select class="param-select ${stateClass}" onchange="updateOperationParam(${moduleIndex}, ${opIndex}, ${paramIndex}, this.value)">
                                <option value="">Select ${param}</option>
                                ${optionsWithAliases.map(opt => {
                                    const isSelected = opt === displayValue;
                                    return `<option value="${opt}" ${isSelected ? 'selected' : ''}>${opt}</option>`;
                                }).join('')}
                            </select>`;
                        } else {
                            return `<input type="text" class="param-input" value="${value}" onchange="updateOperationParam(${moduleIndex}, ${opIndex}, ${paramIndex}, this.value)" placeholder="${param}">`;
                        }
                    }).join('');
                }
            }

            return `
                <div class="operation-line${isSectionComment ? ' comment-section' : ''}">
                    <div class="line-actions">
                        <button class="btn btn-danger btn-small" onclick="removeOperation(${moduleIndex}, ${opIndex})">Remove</button>
                        <button class="btn btn-primary btn-small" onclick="insertOperation(${moduleIndex}, ${opIndex})">Insert</button>
                    </div>
                    <div class="line-number">${lineNumber}</div>
                    <div class="operation-type">
                        <select data-operation="${operation.type}" onchange="updateOperationType(${moduleIndex}, ${opIndex}, this.value)">
                            ${Object.keys(operationTypes).map(type => 
                                `<option value="${type}" ${type === operation.type ? 'selected' : ''}>${operationTypes[type].name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="operation-params">
                        ${paramsHtml}
                        ${operation.type !== 'comment' ? `<input type="checkbox" class="repeat-checkbox" ${operation.repeat ? 'checked' : ''} onchange="updateOperationRepeat(${moduleIndex}, ${opIndex}, this.checked)">` : ''}
                        ${operation.type !== 'comment' ? '<span>Repeat</span>' : ''}
                    </div>
                </div>
            `;
        }



        function addOperation(moduleIndex) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                currentConfig.modules[moduleIndex].operations.push({
                    type: 'comment',
                    text: '',
                    repeat: false
                });
                showModuleOperations(moduleIndex);
            }
        }

        function removeOperation(moduleIndex, opIndex) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                currentConfig.modules[moduleIndex].operations.splice(opIndex, 1);
                showModuleOperations(moduleIndex);
            }
        }

        function insertOperation(moduleIndex, opIndex) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                currentConfig.modules[moduleIndex].operations.splice(opIndex + 1, 0, {
                    type: 'comment',
                    text: '',
                    repeat: false
                });
                showModuleOperations(moduleIndex);
            }
        }

        function updateOperationType(moduleIndex, opIndex, type) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                const operation = currentConfig.modules[moduleIndex].operations[opIndex];
                operation.type = type;
                if (type === 'comment') {
                    operation.text = '';
                    operation.repeat = false;
                } else {
                    operation.params = [];
                    operation.repeat = false;
                }
                
                // Update the data-operation attribute for color
                const selectElement = event.target;
                selectElement.setAttribute('data-operation', type);
                
                showModuleOperations(moduleIndex);
            }
        }

        function updateOperationParam(moduleIndex, opIndex, paramIndex, value) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                const operation = currentConfig.modules[moduleIndex].operations[opIndex];
                if (operation.type === 'comment') {
                    operation.text = value;
                } else {
                    if (!operation.params) operation.params = [];
                    
                    // Remove prefixes for pin values when saving
                    let processedValue = value;
                    if (value && (value.startsWith('out ') || value.startsWith('in '))) {
                        processedValue = value.startsWith('out ') ? value.substring(4) : value.substring(3);
                    }
                    
                    operation.params[paramIndex] = processedValue;
                }
                
                // Re-render to update state colors
                showModuleOperations(moduleIndex);
            }
        }

        function updateOperationRepeat(moduleIndex, opIndex, repeat) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                currentConfig.modules[moduleIndex].operations[opIndex].repeat = repeat;
            }
        }

        function generateModuleText(module) {
            let text = '';
            module.operations.forEach(op => {
                if (op.type === 'comment') {
                    text += `# ${op.text}\n`;
                } else {
                    text += op.type;
                    if (op.params) {
                        // Process params - just use original pin names
                        const processedParams = op.params.map(param => {
                            return param;
                        });
                        
                        text += ' ' + processedParams.join(' ');
                    }
                    if (op.repeat) {
                        text += ' +';
                    }
                    text += '\n';
                }
            });
            // Remove trailing newline
            return text.replace(/\n$/, '');
        }
        
        function generateConfigText() {
            let text = '';
            currentConfig.modules.forEach(module => {
                text += `module ${module.name} ${module.id}\n`;
                
                // Add aliases
                module.aliases.forEach(alias => {
                    if (alias.name && alias.pin) {
                        text += `# alias ${alias.name}=${alias.pin}\n`;
                    }
                });
                
                text += generateModuleText(module);
            });
            return text;
        }
        
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const lineHeight = 27; // Exact line height in pixels
            const lines = textarea.value.split('\n').length;
            const minHeight = 80; // min-height from CSS
            const calculatedHeight = Math.max(minHeight, lines * lineHeight + 4); // +4 for padding
            textarea.style.height = calculatedHeight + 'px';
            
            // Update line numbers
            const lineNumbersContainer = textarea.parentElement.querySelector('.raw-line-numbers');
            if (lineNumbersContainer) {
                const lineNumbers = Array.from({length: lines}, (_, index) => index + 1).join('</div><div class="raw-line-number">');
                lineNumbersContainer.innerHTML = `<div class="raw-line-number">${lineNumbers}</div>`;
            }
        }
        
        function updateModuleFromRaw(moduleIndex, rawText) {
            if (moduleIndex >= 0 && moduleIndex < currentConfig.modules.length) {
                const module = currentConfig.modules[moduleIndex];
                module.aliases = [];
                module.operations = [];
                
                const lines = rawText.split('\n');
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    
                    if (line.startsWith('alias ')) {
                        // Parse alias: "alias <alias_name>=<pin_name>"
                        const aliasMatch = line.match(/^alias\s+([^=]+)=(.*)$/);
                        if (aliasMatch) {
                            const aliasName = aliasMatch[1].trim();
                            const pinName = aliasMatch[2].trim();
                            module.aliases.push({
                                name: aliasName,
                                pin: pinName
                            });
                        }
                    } else if (line.startsWith('# alias ')) {
                        // Parse alias: "# alias <alias_name>=<pin_name>"
                        const aliasMatch = line.match(/^# alias\s+([^=]+)=(.*)$/);
                        if (aliasMatch) {
                            const aliasName = aliasMatch[1].trim();
                            const pinName = aliasMatch[2].trim();
                            module.aliases.push({
                                name: aliasName,
                                pin: pinName
                            });
                        }
                    } else if (line.startsWith('#')) {
                        module.operations.push({
                            type: 'comment',
                            text: line.substring(1).trim(),
                            repeat: false
                        });
                    } else {
                        const parts = line.split(' ');
                        if (parts.length > 0) {
                            const operation = {
                                type: parts[0],
                                repeat: line.endsWith(' +'),
                                params: parts.slice(1)
                            };
                            if (operation.repeat) {
                                operation.params[operation.params.length - 1] = operation.params[operation.params.length - 1].replace(' +', '');
                            }
                            module.operations.push(operation);
                        }
                    }
                }
            }
        }

        function downloadFile() {
            const text = generateConfigText();
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
                                a.download = 'config';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showStatus('Configuration downloaded successfully!', 'success');
        }

        function reloadFromDevice() {
            loadCurrentConfig();
            showStatus('Configuration reloaded from device', 'success');
        }

        function saveToDevice() {
            const text = generateConfigText();
            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: text
            })
            .then(response => {
                if (response.ok) {
                    showStatus('Configuration saved to device successfully! Board will use new config on next restart.', 'success');
                } else {
                    throw new Error('Save failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showStatus('Failed to save configuration to device', 'error');
            });
        }

        function uploadFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseConfig(content);
                renderConfig();
                showStatus('Configuration loaded from file successfully!', 'success');
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html> 