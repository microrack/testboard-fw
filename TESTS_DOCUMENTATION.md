# Документация: Создание тестовых скриптов

## Общее описание

Тестовые скрипты для модулей хранятся в директории `/data/modules/`. Каждый файл содержит определение модуля и набор операций для его тестирования. Парсер этих скриптов находится в `src/modules.cpp`.

## Структура файла тестового скрипта

### 1. Объявление модуля

Каждый скрипт начинается с объявления модуля:

```
module <название> <ID>
```

**Параметры:**
- `<название>` - имя модуля (например, `mod_clk`, `mod_lpg`)
- `<ID>` - числовой идентификатор модуля (уникальный)

**Пример:**
```
module mod_clk 1
module mod_lpg 11
```

### 2. Комментарии и алиасы

Строки, начинающиеся с `#`, являются комментариями и игнорируются парсером.

```
# Это комментарий
# alias clk_in_=0
# alias rst_out=1
```

Алиасы используются для документирования назначения пинов, но не обрабатываются парсером.

### 3. Пустые строки

Пустые строки игнорируются парсером.

## Команды тестового скрипта

### Управляющие команды

#### `reset`
Сброс всех пинов в безопасное состояние.

**Синтаксис:**
```
reset
```

**Пример:**
```
reset
```

#### `delay <время_мс>`
Задержка выполнения на указанное количество миллисекунд.

**Синтаксис:**
```
delay <время_мс>
```

**Параметры:**
- `<время_мс>` - время задержки в миллисекундах

**Пример:**
```
delay 100
delay 500
```

### Команды источников сигналов

#### `src <пин> <напряжение_мВ>`
Установка статического напряжения на источник.

**Синтаксис:**
```
src <пин> <напряжение_мВ>
```

**Параметры:**
- `<пин>` - источник сигнала: `A`, `B`, `C`, `D`
- `<напряжение_мВ>` - напряжение в милливольтах

**Пример:**
```
src A 2000      # Установить 2000 мВ (2 В) на источник A
src B -3000     # Установить -3000 мВ (-3 В) на источник B
src C 1000      # Установить 1000 мВ (1 В) на источник C
```

#### `src_sig <пин> <частота_Гц>`
Запуск генератора сигналов на указанном источнике.

**Синтаксис:**
```
src_sig <пин> <частота_Гц>
```

**Параметры:**
- `<пин>` - источник сигнала: `A`, `B`, `C`, `D`
- `<частота_Гц>` - частота сигнала в герцах

**Пример:**
```
src_sig A 200   # Генерировать сигнал 200 Гц на источнике A
src_sig B 1000  # Генерировать сигнал 1 кГц на источнике B
```

### Команды управления IO пинами

#### `io <номер_пина> <состояние>`
Установка состояния IO пина.

**Синтаксис:**
```
io <номер_пина> <состояние>
```

**Параметры:**
- `<номер_пина>` - номер IO пина (0-15)
- `<состояние>` - состояние пина:
  - `h` - высокий уровень (HIGH)
  - `l` - низкий уровень (LOW)
  - `z` - режим входа (INPUT/High-Z)

**Пример:**
```
io 0 h      # Установить пин 0 в HIGH
io 1 l      # Установить пин 1 в LOW
io 2 z      # Установить пин 2 в режим входа
```

#### `pd <пин> <состояние>`
Управление pull-down резисторами на sink пинах.

**Синтаксис:**
```
pd <пин> <состояние>
```

**Параметры:**
- `<пин>` - **ИГНОРИРУЕТСЯ** (всегда используется PIN_SINK_PD_A)
- `<состояние>` - состояние pull-down:
  - `p` - включить pull-down (HIGH)
  - любое другое значение - выключить pull-down (LOW)

**Пример:**
```
pd A p        # Включить pull-down (первый параметр игнорируется)
pd A n        # Выключить pull-down
```

**⚠️ ВАЖНЫЕ ЗАМЕЧАНИЯ:**
1. Текущая реализация в парсере **всегда** управляет только пином `PIN_SINK_PD_A` (GPB+5), независимо от первого параметра. Пины `PIN_SINK_PD_B` и `PIN_SINK_PD_C` недоступны через эту команду.
2. Команда `pd` нигде не используется в существующих тестах модулей.
3. **Не путайте** команду `pd` с пинами `pdA`, `pdB`, `pdC` - это названия измерительных пинов (SINKPD_A/B/C), используемых в команде `v`:
   ```
   v pdA 0 30    # Это проверка напряжения на пине pdA, НЕ команда pd!
   ```

### Команды проверки тока

#### `i <шина> <мин_мкА> <макс_мкА>`
Проверка потребления тока на указанной шине питания.

**Синтаксис:**
```
i <шина> <мин_мкА> <макс_мкА>
```

**Параметры:**
- `<шина>` - шина питания:
  - `+12` - шина +12В (индекс 0)
  - `+5` - шина +5В (индекс 1)
  - `-12` - шина -12В (индекс 2)
- `<мин_мкА>` - минимальный допустимый ток в микроамперах
- `<макс_мкА>` - максимальный допустимый ток в микроамперах

**Пример:**
```
i +12 0 50000       # Проверить, что ток на +12В между 0 и 50 мА
i +5 2000 6000      # Проверить, что ток на +5В между 2 и 6 мА
i -12 5000 7000     # Проверить, что ток на -12В между 5 и 7 мА
```

### Команды проверки напряжения

#### `v <пин> <мин_мВ> <макс_мВ>`
Проверка напряжения на указанном пине.

**Синтаксис:**
```
v <пин> <мин_мВ> <макс_мВ>
```

**Параметры:**
- `<пин>` - пин для измерения напряжения:
  - `A`, `B`, `C`, `D`, `E`, `F` - основные пины (ADC_sink_1k_A..F)
  - `pdA`, `pdB`, `pdC` - пины с pull-down (ADC_sink_PD_A..C)
  - `zD`, `zE`, `zF` - пины с высоким импедансом (ADC_sink_Z_D..F)
- `<мин_мВ>` - минимальное допустимое напряжение в милливольтах
- `<макс_мВ>` - максимальное допустимое напряжение в милливольтах

**Пример:**
```
v A 120 190         # Проверить, что напряжение на пине A между 120 и 190 мВ
v pdA 0 30          # Проверить, что напряжение на pdA между 0 и 30 мВ
v zD 490 650        # Проверить, что напряжение на zD между 490 и 650 мВ
```

### Команды анализа сигналов

#### `scope <пин> <частота_дискр_Гц> <размер_буфера>`
Запуск осциллографа для захвата сигнала.

**Синтаксис:**
```
scope <пин> <частота_дискр_Гц> <размер_буфера>
```

**Параметры:**
- `<пин>` - пин для измерения (A, B, C, D, E, F, pdA, pdB, pdC, zD, zE, zF)
- `<частота_дискр_Гц>` - частота дискретизации в герцах
- `<размер_буфера>` - размер буфера для захвата

**Пример:**
```
scope A 20000 512   # Захватить сигнал на пине A с частотой 20 кГц, буфер 512 отсчетов
```

**Важно:** После команды `scope` обычно следуют команды проверки параметров сигнала.

#### `min <пин> <мин_мВ> <макс_мВ>`
Проверка минимального значения захваченного сигнала.

**Синтаксис:**
```
min <пин> <мин_мВ> <макс_мВ>
```

**Параметры:**
- `<пин>` - пин для анализа
- `<мин_мВ>` - минимальное допустимое значение минимума в мВ
- `<макс_мВ>` - максимальное допустимое значение минимума в мВ

**Пример:**
```
scope A 20000 512
min A -100 100      # Проверить, что минимум сигнала между -100 и 100 мВ
```

#### `max <пин> <мин_мВ> <макс_мВ>`
Проверка максимального значения захваченного сигнала.

**Синтаксис:**
```
max <пин> <мин_мВ> <макс_мВ>
```

**Параметры:**
- `<пин>` - пин для анализа
- `<мин_мВ>` - минимальное допустимое значение максимума в мВ
- `<макс_мВ>` - максимальное допустимое значение максимума в мВ

**Пример:**
```
scope A 20000 512
max A 4900 5100     # Проверить, что максимум сигнала между 4900 и 5100 мВ
```

#### `avg <пин> <мин_мВ> <макс_мВ>`
Проверка среднего значения захваченного сигнала.

**Синтаксис:**
```
avg <пин> <мин_мВ> <макс_мВ>
```

**Параметры:**
- `<пин>` - пин для анализа
- `<мин_мВ>` - минимальное допустимое среднее значение в мВ
- `<макс_мВ>` - максимальное допустимое среднее значение в мВ

**Пример:**
```
scope A 20000 512
avg A 2400 2600     # Проверить, что среднее значение между 2400 и 2600 мВ
```

#### `freq <пин> <мин_Гц> <макс_Гц>`
Проверка частоты захваченного сигнала.

**Синтаксис:**
```
freq <пин> <мин_Гц> <макс_Гц>
```

**Параметры:**
- `<пин>` - пин для анализа
- `<мин_Гц>` - минимальная допустимая частота в герцах
- `<макс_Гц>` - максимальная допустимая частота в герцах

**Пример:**
```
scope A 20000 512
freq A 190 210      # Проверить, что частота сигнала между 190 и 210 Гц
```

#### `amplitude <пин> <мин_мВ> <макс_мВ>`
Проверка амплитуды захваченного сигнала (max - min).

**Синтаксис:**
```
amplitude <пин> <мин_мВ> <макс_мВ>
```

**Параметры:**
- `<пин>` - пин для анализа
- `<мин_мВ>` - минимальная допустимая амплитуда в мВ
- `<макс_мВ>` - максимальная допустимая амплитуда в мВ

**Пример:**
```
scope A 20000 512
amplitude A 0 200       # Проверить, что амплитуда между 0 и 200 мВ
amplitude A 2300 2800   # Проверить, что амплитуда между 2300 и 2800 мВ
```

## Специальные возможности

### Флаг повторения (+)

Любую команду можно пометить флагом `+` в конце строки. Это означает, что операция будет повторяться до успешного выполнения.

**Синтаксис:**
```
<команда> <параметры>  +
```

**Важно:** Между параметрами и знаком `+` должны быть пробелы!

**Пример:**
```
v A 4100 5100                  +
```

Эта команда будет повторяться, пока напряжение не войдет в диапазон 4100-5100 мВ.

**Применение:**
- Для команд, результат которых может не сразу установиться
- Для ожидания стабилизации значений
- Для интерактивных тестов, требующих действий пользователя

**Важно:** При использовании флага повторения проверяется состояние шин питания. Если питание отключено, повторение прекращается.

## Примеры тестовых скриптов

### Пример 1: Простая проверка тока (mod_clk)

```
module mod_clk 1
# alias clk_in_=0
# alias rst_out=1
# alias clk_out=2
# # setup
reset
# # check current
i +12 0 50000
i +5 0 50000
i -12 0 50000
```

**Описание:**
1. Объявление модуля `mod_clk` с ID=1
2. Комментарии с алиасами пинов
3. Сброс всех пинов
4. Проверка тока на всех шинах питания

### Пример 2: Проверка с напряжением (mod_jacket.bck)

```
module mod_jacket 9
# alias ch1_A=out A
# alias ch1_B=0
# alias ch1_out=in A
# # setup
reset 
# # check current
i +12 0 1000
i +5 2000 6000
i -12 0 2000
# # check channel 1
reset 
src A 2000
v A 120 190
reset 
io 0 h
v A 4100 5100                  +
```

**Описание:**
1. Сброс и проверка тока покоя
2. Проверка канала 1:
   - Установка напряжения 2000 мВ на источник A
   - Проверка, что на выходе 120-190 мВ
   - Сброс
   - Установка IO пина 0 в HIGH
   - Проверка с повторением, что напряжение 4100-5100 мВ

### Пример 3: Проверка сигналов (mod_lpg.bck)

```
module mod_lpg 11
# # main check
reset 
src_sig A 200
delay 100
# no CV, check for no signal
scope A 20000 512
amplitude A 0 200
delay 100
# add CV, check for signal
src D -3000
scope A 20000 512
amplitude A 2300 2800
# add IO, check signal drop
io 4 h
scope A 20000 512
amplitude A 0 200
```

**Описание:**
1. Сброс системы
2. Запуск генератора 200 Гц на источнике A
3. Задержка 100 мс
4. Захват сигнала и проверка малой амплитуды (нет CV)
5. Добавление управляющего напряжения -3000 мВ
6. Проверка увеличения амплитуды (2300-2800 мВ)
7. Установка IO пина в HIGH
8. Проверка уменьшения амплитуды

## Порядок выполнения команд

1. Команды выполняются последовательно, сверху вниз
2. Комментарии и пустые строки пропускаются
3. При использовании флага `+` команда повторяется до успеха
4. Если команда без флага `+` проваливается, выполнение останавливается
5. Результаты всех проверок сохраняются в массив результатов

## Внутренняя структура данных

### test_operation_t

Каждая команда преобразуется в структуру:

```c
typedef struct {
    bool repeat;           // true если есть флаг +
    test_op_type_t op;    // Тип операции
    int pin;              // Номер пина
    int32_t arg1;         // Первый аргумент
    int32_t arg2;         // Второй аргумент (для диапазонов)
} test_operation_t;
```

### test_operation_result_t

Результат выполнения сохраняется в:

```c
typedef struct {
    bool passed;                // true если тест прошел
    int32_t result;             // фактическое значение
    uint32_t execution_time_ms; // время выполнения в мс
} test_operation_result_t;
```

## Типичные паттерны использования

### Паттерн 1: Базовая проверка модуля

```
module <имя> <ID>
reset
i +12 <мин> <макс>
i +5 <мин> <макс>
i -12 <мин> <макс>
```

### Паттерн 2: Проверка пассивного прохождения сигнала

```
reset
src <источник> <напряжение>
v <приемник> <мин> <макс>
```

### Паттерн 3: Проверка активной обработки сигнала

```
reset
src_sig <источник> <частота>
delay <время_установления>
scope <приемник> <частота_дискр> <буфер>
amplitude <приемник> <мин> <макс>
freq <приемник> <мин> <макс>
```

### Паттерн 4: Проверка переключения состояний

```
reset
io <пин> l
v <проверяемый_пин> <мин_low> <макс_low>
io <пин> h
v <проверяемый_пин> <мин_high> <макс_high>
```

### Паттерн 5: Интерактивная проверка с повторением

```
reset
<команда_установки>
<команда_проверки>                  +
```

## Отладка тестов

### Логирование

Парсер выводит отладочную информацию через ESP_LOG:
- `ESP_LOGD` - детальная информация о парсинге
- `ESP_LOGI` - информация о выполнении операций
- `ESP_LOGW` - предупреждения о неизвестных командах
- `ESP_LOGE` - ошибки

### Проверка парсинга

После загрузки модулей в логах появится:
```
Successfully loaded <N> modules with <M> total operations
```

### Проверка выполнения

Для каждой операции выводится информация:
```
Setting source A to 2000 mV
Checking pin A voltage: expected [120, 190] mV, got <значение> mV
```

## Ограничения и особенности

1. **Размер токенов:** Максимальная длина токена - 63 символа
2. **Память:** Все операции загружаются в RAM при инициализации
3. **Порядок:** Команды должны следовать в логическом порядке
4. **Задержки:** После некоторых операций (src_sig, io) требуются задержки
5. **Scope:** Команды анализа сигнала работают только после `scope`
6. **Repeat:** Флаг `+` должен быть отделен пробелами от параметров
7. **⚠️ Команда pd:** Первый параметр команды `pd` игнорируется парсером, всегда используется только `PIN_SINK_PD_A`. Для управления `PIN_SINK_PD_B` и `PIN_SINK_PD_C` потребуется доработка парсера

## Расположение файлов

- **Тестовые скрипты:** `/data/modules/mod_<название>`
- **Парсер:** `src/modules.cpp`
- **Заголовки:** `include/modules.h`
- **Конфигурация:** `/config` (не используется, загружаются отдельные файлы модулей)

## Советы по созданию тестов

1. **Всегда начинайте с reset** - это гарантирует чистое начальное состояние
2. **Проверяйте ток покоя** - первые три команды обычно проверка токов
3. **Используйте задержки** - после src_sig и io дайте схеме время на установление
4. **Документируйте алиасы** - комментарии помогают понять назначение пинов
5. **Используйте scope перед анализом** - команды min, max, avg, freq, amplitude требуют захваченных данных
6. **Устанавливайте адекватные диапазоны** - слишком узкие диапазоны приведут к ложным отказам
7. **Используйте флаг + осторожно** - бесконечные циклы могут заблокировать систему
8. **Группируйте проверки логически** - разделяйте комментариями разные этапы теста

## Примечания

- Парсер регистрозависим для команд и параметров
- Пробелы и табуляции используются как разделители
- Строки могут заканчиваться `\n` или `\r\n`
- Неизвестные команды вызывают предупреждение и пропускаются
- Файлы читаются из LittleFS файловой системы

